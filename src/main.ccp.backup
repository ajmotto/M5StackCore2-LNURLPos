#include <M5Core2.h>
#include <string.h>
#include <qrcode.h>
#include <Bitcoin.h>
//#include <Base64.h>
#include <Hash.h>
#include <Conversion.h>


////////////////////////////////////////////////////////
////////CHANGE! USE LNURLPoS EXTENSION IN LNBITS////////
////////////////////////////////////////////////////////

String server = "https://njvijay-umbrel.ngrok.io";
String posId = "JhCX7ACbchA27C4Qb7NNZ9";
String key = "KzGWWEYeJaZVMVkTBGARRt";
String currency = "USD";

////////////////////////////////////////////////////////
////Note: See lines 75, 97, to adjust to keypad size////
////////////////////////////////////////////////////////

//////////////VARIABLES///////////////////

String dataId = "";
bool paid = false;
bool shouldSaveConfig = false;
bool down = false;
const char* spiffcontent = "";
String spiffing; 
String lnurl;
String choice;
String payhash;
String key_val;
String cntr = "0";
String inputs="10";
int keysdec;
int keyssdec;
float temp;  
String fiat;
float satoshis;
String nosats;
float conversion;
String virtkey;
String payreq;
int randomPin;
bool settle = false;
String preparedURL;

SHA256 h;

//UI Design

#define orange 0xFC64
#define dark 0x02F3
#define darkOrange 0xC18A
#define red 0xFC7F
#define purple 0xC18A
#define light 0xCF3E

int posX2[4];
int n2=4;
int boxSize2=45;
int space2=3;
int start2=25;
String math2="";
float numbers2[3]={0,0,0};
int fase2=0;
char buttons2[4][4]={{'7','4','1','0'},{'8','5','2','.'},{'9','6','3','='},{'/','*','-','+'}};
char operation2=' ';
bool irq2 = false;

int posX[7];

int boxSize=26;
int space=2;
int start=21;


void resetCalc(){
  for(int i=0;i<3;i++)
  numbers2[i]=0;
  math2="";
   M5.Lcd.fillRoundRect(posX2[0],3,188,40,4,dark);
 

  }

void startCalc()
  {

        resetCalc();
        M5.Lcd.fillRect(0,0,319,239,WHITE);
        //M5.Lcd.pushImage(240,160,64,64,calc[moode]);
     M5.Lcd.setTextColor(light);
     M5.Lcd.setTextFont(4);
    for(int i=0;i<n2;i++) {
        posX2[i]=(start2+(i*boxSize2)+(space2*i));
        Serial.printf("Posx %d: %d", i, posX2[i]);
    }
    //Top calculator Display
    M5.Lcd.fillRoundRect(posX2[0],3,188,40,8,dark);
    M5.Lcd.drawString("0",180,8,4);

   for(int i=0;i<n2;i++)
    for(int j=0;j<n2;j++){

    if(j<3 && i <3 )
    M5.Lcd.fillRoundRect(posX2[i],posX2[j]+22,boxSize2,boxSize2,4,dark);
    else
    M5.Lcd.fillRoundRect(posX2[i],posX2[j]+22,boxSize2,boxSize2,4,darkOrange);

    M5.Lcd.drawString(String(buttons2[i][j]), posX2[i]+16, posX2[j]+34);
    
    }}


//////////LNURL AND CRYPTO///////////////
void to_upper(char * arr){
  for (size_t i = 0; i < strlen(arr); i++)
  {
    if(arr[i] >= 'a' && arr[i] <= 'z'){
      arr[i] = arr[i] - 'a' + 'A';
    }
  }
}

void encode_data(byte output[8], byte nonce[8], int pin, int amount_in_cents){
  SHA256 h;
  h.write(nonce, 8);
  h.write((byte *)key.c_str(), key.length());
  h.end(output);
  output[0] = output[0] ^ ((byte)(pin & 0xFF));
  output[1] = output[1] ^ ((byte)(pin >> 8));
  for(int i=0; i<4; i++){
    output[2+i] = output[2+i] ^ ((byte)(amount_in_cents & 0xFF));
    amount_in_cents = amount_in_cents >> 8;
  }
}


////VERY KINDLY DONATED BY SNIGIREV!/////

void makeLNURL(){
  randomPin = random(1000,9999);
  byte nonce[8];
  for(int i = 0; i < 8;i++){
    nonce[i] = random(9);
  }
  byte payload[8];
  encode_data(payload, nonce, randomPin, inputs.toInt());
  preparedURL = server + "/lnurlpos/api/v1/lnurl/";
  preparedURL += toHex(nonce,8);
  preparedURL += "/";
  preparedURL += toHex(payload, 8);
  preparedURL += "/";
  preparedURL += posId;
  Serial.println(preparedURL);
  char Buf[200];
  preparedURL.toCharArray(Buf, 200);
  char *url = Buf;
  byte * data = (byte *)calloc(strlen(url)*2, sizeof(byte));
  size_t len = 0;
  int res = convert_bits(data, &len, 5, (byte *)url, strlen(url), 8, 1);
  Serial.printf("Convert Bits = %d",res);
  char * charLnurl = (char *)calloc(strlen(url)*2, sizeof(byte));
  bech32_encode(charLnurl, "lnurl", data, len);
  to_upper(charLnurl);
  lnurl = charLnurl;
  Serial.println(lnurl);
}



void setup(void) {
  
  M5.begin();
  M5.Lcd.fillScreen(TFT_BLACK);
  //M5.Lcd.setSwapBytes(true);
  //resetCalc();
  startCalc();
  //M5.Lcd.fillScreen(BLACK);
  //M5.Lcd.setCursor(0,6,2);
  //M5.Lcd.setTextColor(0x0775);
  //M5.Lcd.println("LNURLPOS");
  //makeLNURL();
  //m5.Lcd.qrcode(lnurl,50,10,220,6U);
}

void loop(void) {
}